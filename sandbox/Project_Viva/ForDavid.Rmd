---
title: "Prenatal metals (1st trimester) and mitochondrial DNA copy number and telomere length in maternal second trimester and cord blood"
author: "Anna Smith"
date: "09/27/2021"
output: html_document

# Created: 09/27/2021 
# Updated: 
# Includes: Data for CVtreemle
---

```{r globals}
library(SuperNOVA)
library(here)
library(readr)
library(tidyverse)
seed <- 11122441
```
#prenatal metal mixture and cord blood mitochondrial DNA copy number (mtDNAcn)

```{r cord blood mtDNA}

mtDNA_birth<- read_csv(here("sandbox/Project_Viva/mtDNA_birth.csv"))

#Recode plate number to factor variable
mtDNA_birth$dna_copyn_assay_plate_child<- as.factor(
  mtDNA_birth$dna_copyn_assay_plate_child)

table(mtDNA_birth$dna_copyn_assay_plate_child)

#Recode race to factor variable
mtDNA_birth$race2_mom_epi_epia_d<- as.factor(
  mtDNA_birth$race2_mom_epi_epia_d)

table(mtDNA_birth$race2_mom_epi_epia_d)

#recode other variables to factor variables
mtDNA_birth$coll_grad<- as.factor(mtDNA_birth$coll_grad)
mtDNA_birth$gt70k<- as.factor(mtDNA_birth$gt70k)
mtDNA_birth$smokpreg_final_d<- as.factor(mtDNA_birth$smokpreg_final_d)
mtDNA_birth$nullip<- as.factor(mtDNA_birth$nullip)
mtDNA_birth$female_d<- as.factor(mtDNA_birth$female_d)

#save the names of the mixture variables in the variable "Xnm"
#note: non log2-transformed metals = "As" "Ba", etc. if want to use those instead
exposure = c("As", "Ba", "Cd", "Cs", "Hg", "Mg", 
             "Mn", "Pb", "Se", "Zn")

deltas = c("As" = 1, "Ba" = 1, "Cd" = 1, "Cs" = 1 , "Hg" = 1, "Mg" = 1, 
             "Mn" = 1, "Pb" = 1, "Se" = 1, "Zn" = 1)

exposures <- mtDNA_birth[exposure]

mediator <- mtDNA_birth["dna_copyn_mean_child"]

#log2 transform the outcome
#note: non log2-transformed outcomes = original value 
mtDNA_birth$dna_copyn_mean_child<- log2(mtDNA_birth$dna_copyn_mean_child)
outcome = mtDNA_birth[["birthweight_d"]]

#save covariates in variable covars
covars = mtDNA_birth[c('dna_copyn_assay_plate_child', 'age_mom_enroll_d', 
           'bmi_mom_prepreg_d', 'race2_mom_epi_epia_d', 'coll_grad', 'gt70k', 
           'smokpreg_final_d', 'nullip', 'female_d')]

mtDNA_birth <- as.data.frame(unclass(mtDNA_birth),                
                       stringsAsFactors = TRUE)

mtDNA_birth <- mtDNA_birth %>% 
  mutate_if(is.numeric, ~tidyr::replace_na(.,mean(., na.rm = TRUE)))



mtDNA_birth_results <- SuperNOVA(w = covars,
                                 a = exposures,
                                 z = mediator, 
                                 y = outcome,
                                 seed = seed,
                                 n_folds = 10,
                                 outcome_type =  "continuous", 
                                 num_cores = 7,
                                 deltas = deltas,
                                 var_sets = "As-dna_copyn_mean_child",
                                 n_bins = 4)
```

Let's first look at the pooled results for mixture rules found, if any: 

```{r pooled mixture results cord blood mtDNA}
mtDNA_birth_results$`Pooled TMLE Mixture Results`
```
Above we show interactions based on thresholds for Ba and Hg, CD and Mg, and 
CD and SE. However, the ATE for all of these is not significant. Additionally,
these combinations of exposures were only identified in one fold and
are therefore inconsistent. 

Because only one pooled result exists, only one v-fold specific result will 
also be found:

```{r fold mixture results cord blood mtDNA}
mtDNA_birth_results$`V-Specific Mix Results`
```


So no true interactions are found which are consistent with strong effects, 
let's look at the marginal results:

```{r pooled marginal results cord blood mtDNA}
mtDNA_birth_results$`Pooled TMLE Marginal Results`
```
Only 1 threshold was found for magnesium which is not significant. 

```{r fold marginal results cord blood mtDNA}
mtDNA_birth_results$`V-Specific Marg Results`
```
Because only one marginal result is found in the pooled result we expect the 
same for v-fold specific results. 

#prenatal metal mixture and maternal mtDNAcn
```{r maternal mtDNA}
library(readr)
mtDNA_maternal<- read_csv(here("sandbox/Project_Viva/mtDNA_maternal.csv"))

#Recode plate number to factor variable
mtDNA_maternal$dna_copyn_assay_plate_mom<- as.factor(
  mtDNA_maternal$dna_copyn_assay_plate_mom)

table(mtDNA_maternal$dna_copyn_assay_plate_mom)

#Recode race to factor variable
mtDNA_maternal$race2_mom_epi_epia_d<- as.factor(
  mtDNA_maternal$race2_mom_epi_epia_d)

table(mtDNA_maternal$race2_mom_epi_epia_d)

#recode other variables to factor variables
mtDNA_maternal$coll_grad<- as.factor(mtDNA_maternal$coll_grad)
mtDNA_maternal$gt70k<- as.factor(mtDNA_maternal$gt70k)
mtDNA_maternal$smokpreg_final_d<- as.factor(mtDNA_maternal$smokpreg_final_d)
mtDNA_maternal$nullip<- as.factor(mtDNA_maternal$nullip)

#save the names of the mixture variables in the variable "Xnm"
#note: non log2-transformed metals = "As" "Ba", etc. if want to use those instead
exposures = c("As", "Ba", "Cd", "Cs", "Hg", 
             "Mg", "Mn", "Pb", "Se", "Zn")

exposures <- mtDNA_maternal[exposures]

#log2 transform the outcome
#note: non log2-transformed outcomes = original value 
mtDNA_maternal$dna_copyn_mean_mom<- log2(mtDNA_maternal$dna_copyn_mean_mom)

mediator = mtDNA_maternal["dna_copyn_mean_mom"]
outcome = mtDNA_maternal["birthweight_d"]
#save covariates in variable covars
covars = mtDNA_maternal[c('dna_copyn_assay_plate_mom', 'age_mom_enroll_d', 
            'race2_mom_epi_epia_d', 'coll_grad',
           'gt70k', 'smokpreg_final_d', 'nullip')]

seed <- 00439409
mtDNA_maternal_results <- SuperNOVA(w = covars,
                                 a = exposures,
                                 z = mediator, 
                                 y = outcome,
                                 seed = seed,
                                 n_folds = 10,
                                 outcome_type =  "continuous", 
                                 num_cores = 7,
                                 deltas = deltas,
                                 var_sets = "As-dna_copyn_mean_child",
                                 n_bins = 4)
```

```{r pooled mixture results maternal mtDNA}
mtDNA_maternal_results$`Pooled TMLE Mixture Results`
```


```{r fold mix results maternal mtDNA}
mtDNA_maternal_results$`V-Specific Mix Results`
```

```{r pooled marginal results maternal mtDNA}
mtDNA_maternal_results$`Pooled TMLE Marginal Results`
```
```{r fold marginal results maternal mtDNA}
mtDNA_maternal_results$`V-Specific Marg Results`
```


Prenatal metal mixture and cord blood telomere lenth (TL)
```{r cord blood TL}
library(readr)
TL_birth<- read_csv(here("sandbox/Project_Viva/TL_birth.csv"))

#Recode plate number to factor variable
TL_birth$TL_plate_child<- as.factor(TL_birth$TL_plate_child)
table(TL_birth$TL_plate_child)

#Recode race to factor variable
TL_birth$race2_mom_epi_epia_d<- as.factor(TL_birth$race2_mom_epi_epia_d)
table(TL_birth$race2_mom_epi_epia_d)

#recode other variables to factor variables
TL_birth$coll_grad<- as.factor(TL_birth$coll_grad)
TL_birth$gt70k<- as.factor(TL_birth$gt70k)
TL_birth$smokpreg_final_d<- as.factor(TL_birth$smokpreg_final_d)
TL_birth$nullip<- as.factor(TL_birth$nullip)
TL_birth$female_d<- as.factor(TL_birth$female_d)

#save the names of the mixture variables in the variable "Xnm"
#note: non log2-transformed metals = "As" "Ba", etc. if want to use those instead
exposure = c("As", "Ba", "Cd", "Cs", "Hg", "Mg", 
             "Mn", "Pb", "Se", "Zn")

deltas = c("As" = 1, "Ba" = 1, "Cd" = 1, "Cs" = 1 , "Hg" = 1, "Mg" = 1, 
             "Mn" = 1, "Pb" = 1, "Se" = 1, "Zn" = 1)

exposures <- TL_birth[exposure]

mediator <- TL_birth["TL_mean_child"]

#log2 transform the outcome
#note: non log2-transformed outcomes = original value 
outcome = TL_birth[["birthweight_d"]]

#save covariates in variable covars
covars = TL_birth[c('TL_plate_child', 'age_mom_enroll_d', 
           'bmi_mom_prepreg_d', 'race2_mom_epi_epia_d', 'coll_grad', 'gt70k', 
           'smokpreg_final_d', 'nullip', 'female_d')]

TL_birth <- as.data.frame(unclass(TL_birth),                
                       stringsAsFactors = TRUE)

TL_birth <- TL_birth %>% 
  mutate_if(is.numeric, ~tidyr::replace_na(.,mean(., na.rm = TRUE)))

TL_birth_results <-SuperNOVA(w = covars,
                                 a = exposures,
                                 z = mediator, 
                                 y = outcome,
                                 seed = seed,
                                 n_folds = 5,
                                 outcome_type =  "continuous", 
                                 num_cores = 7,
                                 deltas = deltas,
                                 var_sets = "As-TL_mean_child",
                                 n_bins = 4)
```

```{r pooled mixture results TL birth}
TL_birth_results$`Pooled TMLE Mixture Results`
```

```{r fold mixture results TL birth}
TL_birth_results$`V-Specific Mix Results`
```


```{r pooled marginal results TL birth}
TL_birth_results$`Pooled TMLE Marginal Results`
```

```{r fold marginal results TL birth}
TL_birth_results$`V-Specific Marg Results`
```

Prenatal metal mixture and maternal TL
```{r maternal TL}
library(readr)
TL_maternal<- read_csv("TL_maternal.csv")

#Recode plate number to factor variable
TL_maternal$TL_plate_mom<- as.factor(TL_maternal$TL_plate_mom)
table(TL_maternal$TL_plate_mom)

#Recode race to factor variable
TL_maternal$race2_mom_epi_epia_d<- as.factor(TL_maternal$race2_mom_epi_epia_d)
table(TL_maternal$race2_mom_epi_epia_d)

#recode other variables to factor variables
TL_maternal$coll_grad<- as.factor(TL_maternal$coll_grad)
TL_maternal$gt70k<- as.factor(TL_maternal$gt70k)
TL_maternal$smokpreg_final_d<- as.factor(TL_maternal$smokpreg_final_d)
TL_maternal$nullip<- as.factor(TL_maternal$nullip)

#save the names of the mixture variables in the variable "Xnm"
#note: non log2-transformed metals = "As" "Ba", etc. if want to use those instead
exposure = c("log2As", "log2Ba", "log2Cd", "log2Cs", "log2Hg", 
             "log2Mg", "log2Mn", "log2Pb", "log2Se", "log2Zn")

#log2 transform the outcome
#note: non log2-transformed outcomes = original value
TL_maternal$TL_mean_mom<- log2(TL_maternal$TL_mean_mom)
outcome = c("TL_mean_mom")

#save covariates in variable covars
covars = c('TL_plate_mom', 'age_mom_enroll_d', 'bmi_mom_prepreg_d', 
           'race2_mom_epi_epia_d', 'coll_grad', 'gt70k', 'smokpreg_final_d', 
           'nullip')

TL_maternal <- as.data.frame(unclass(TL_maternal),                
                       stringsAsFactors = TRUE)

TL_maternal <- TL_maternal %>% 
  mutate_if(is.numeric, ~tidyr::replace_na(.,mean(., na.rm = TRUE)))

TL_maternal_results <- CVtreeMLE(data = as.data.frame(TL_maternal),
                                 w = covars,
                                 y = outcome,
                                 a = exposure,
                                 seed = seed,
                                 n_folds = 10,
                                 family = "continuous", 
                                 parallel_cv =  TRUE, 
                                 num_cores = 7)

```

```{r pooled mixture results TL maternal}
TL_maternal_results$`Pooled TMLE Mixture Results`
```
```{r fold mixture results TL maternal}
TL_maternal_results$`V-Specific Mix Results`
```
```{r pooled marginal results TL maternal}
TL_maternal_results$`Pooled TMLE Marginal Results`
```

```{r fold marginal results TL maternal}
TL_maternal_results$`V-Specific Marg Results`
```
